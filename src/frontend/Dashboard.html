<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام نجارة ERP | الإصدار الثالث</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        /* --- THEME COLORS (Deep Navy & Grey) --- */
        --bg-body: #0a0e17; /* Very Dark Navy */
        --bg-panel: rgba(20, 25, 35, 0.7);
        --bg-glass: rgba(30, 35, 45, 0.4);

        /* --- MODULE COLORS (Darkest Levels) --- */
        --color-sys: #0d47a1; /* Deep Blue */
        --color-hrm: #1b5e20; /* Deep Green */
        --color-prj: #bf8d0a; /* Deep Gold/Bronze */
        --color-fin: #b71c1c; /* Deep Red */

        /* --- ACCENTS & TEXT --- */
        --accent-glow: rgba(255, 255, 255, 0.1);
        --text-main: #ffffff;
        --text-muted: #8fa3bf;
        --border-light: rgba(255, 255, 255, 0.08);
        --border-highlight: rgba(255, 255, 255, 0.2);

        /* --- 3D GLASS EFFECTS --- */
        --glass-shadow: 15px 15px 30px rgba(0, 0, 0, 0.6),
          -5px -5px 15px rgba(255, 255, 255, 0.03),
          inset 1px 1px 1px rgba(255, 255, 255, 0.1),
          inset -1px -1px 1px rgba(0, 0, 0, 0.5);

        --glass-surface: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.05) 0%,
          rgba(255, 255, 255, 0.01) 100%
        );

        --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Cairo", sans-serif;
        outline: none;
        scrollbar-width: thin;
        scrollbar-color: var(--border-highlight) transparent;
      }

      body {
        background-color: var(--bg-body);
        background-image: radial-gradient(
            circle at 10% 20%,
            rgba(13, 71, 161, 0.15) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(183, 28, 28, 0.1) 0%,
            transparent 40%
          );
        color: var(--text-main);
        overflow: hidden;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* --- UTILS --- */
      .hidden {
        display: none !important;
        opacity: 0;
        pointer-events: none;
      }
      .fade-in {
        animation: fadeIn 0.6s forwards;
      }
      .fade-out {
        animation: fadeOut 0.6s forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: scale(1);
        }
        to {
          opacity: 0;
          transform: scale(1.05);
        }
      }

      /* --- 1. LOGIN SCREEN --- */
      #login-screen {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 200;
      }

      .login-glass {
        width: 400px;
        padding: 50px 40px;
        border-radius: 30px;
        background: var(--bg-panel);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border: 1px solid var(--border-light);
        box-shadow: var(--glass-shadow);
        position: relative;
        overflow: hidden;
      }

      /* Glancing Light Effect */
      .login-glass::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent 40%,
          rgba(255, 255, 255, 0.05) 50%,
          transparent 60%
        );
        animation: glance 6s infinite;
        pointer-events: none;
      }

      @keyframes glance {
        0% {
          transform: rotate(0deg) translate(-100px, -100px);
        }
        100% {
          transform: rotate(360deg) translate(100px, 100px);
        }
      }

      .logo-text {
        font-size: 3.5rem;
        font-weight: 900;
        margin-bottom: 5px;
        background: linear-gradient(to bottom, #fff, #8fa3bf);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
      }

      .input-box {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-light);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        transition: var(--transition);
      }

      .input-box:focus-within {
        border-color: var(--text-muted);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.05);
        background: rgba(0, 0, 0, 0.5);
      }

      .input-box i {
        color: var(--text-muted);
        margin-left: 15px;
        font-size: 1.2rem;
      }

      .input-field {
        background: transparent;
        border: none;
        color: #fff;
        width: 100%;
        font-size: 1rem;
      }

      .btn-login {
        width: 100%;
        padding: 18px;
        border-radius: 15px;
        background: linear-gradient(135deg, #1e2532 0%, #0a0e17 100%);
        border: 1px solid var(--border-light);
        color: var(--text-main);
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5),
          -2px -2px 10px rgba(255, 255, 255, 0.05);
        transition: var(--transition);
      }

      .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6);
        border-color: var(--text-muted);
      }

      /* --- 2. MAIN DASHBOARD HUB --- */
      #dashboard-screen {
        width: 95%;
        max-width: 1400px;
        height: 90vh;
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* 4 Modules Side by Side */
        gap: 25px;
        perspective: 1500px;
        padding: 20px;
      }

      .module-card {
        background: var(--bg-panel);
        border-radius: 30px;
        border: 1px solid var(--border-light);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
        box-shadow: var(--glass-shadow);
      }

      /* Specific Module Colors & Glows */
      .mod-sys {
        border-bottom: 4px solid var(--color-sys);
      }
      .mod-hrm {
        border-bottom: 4px solid var(--color-hrm);
      }
      .mod-prj {
        border-bottom: 4px solid var(--color-prj);
      }
      .mod-fin {
        border-bottom: 4px solid var(--color-fin);
      }

      .module-card:hover {
        transform: scale(1.05) translateZ(30px);
        z-index: 10;
        border-color: rgba(255, 255, 255, 0.3);
      }

      .mod-sys:hover {
        box-shadow: 0 0 40px rgba(13, 71, 161, 0.3);
      }
      .mod-hrm:hover {
        box-shadow: 0 0 40px rgba(27, 94, 32, 0.3);
      }
      .mod-prj:hover {
        box-shadow: 0 0 40px rgba(191, 141, 10, 0.3);
      }
      .mod-fin:hover {
        box-shadow: 0 0 40px rgba(183, 28, 28, 0.3);
      }

      /* The Main Icon */
      .module-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        transition: var(--transition);
        filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.5));
      }

      .mod-sys .module-icon {
        color: var(--color-sys);
      }
      .mod-hrm .module-icon {
        color: var(--color-hrm);
      }
      .mod-prj .module-icon {
        color: var(--color-prj);
      }
      .mod-fin .module-icon {
        color: var(--color-fin);
      }

      .module-title {
        font-size: 1.8rem;
        font-weight: 800;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Sub-Module Grid Reveal */
      .sub-menu {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 14, 23, 0.95);
        backdrop-filter: blur(15px);
        display: grid;
        grid-template-columns: 1fr;
        align-content: center;
        gap: 10px;
        padding: 20px;
        opacity: 0;
        pointer-events: none;
        transform: translateY(20px);
        transition: var(--transition);
      }

      .module-card:hover .sub-menu {
        opacity: 1;
        pointer-events: all;
        transform: translateY(0);
      }

      .sub-link {
        padding: 12px;
        margin: 0 10px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid transparent;
        color: var(--text-muted);
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: 0.2s;
        font-size: 0.95rem;
      }

      .sub-link:hover {
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        transform: translateX(-5px);
        border-color: var(--border-light);
      }

      .sub-link i {
        width: 20px;
        text-align: center;
      }

      /* --- 3. QUICK NAVIGATION BAR (Hover Reveal) --- */
      #quick-nav {
        position: fixed;
        right: 0;
        top: 50%;
        transform: translateY(-50%) translateX(90%); /* Hidden initially */
        width: 80px;
        height: 60vh;
        background: rgba(20, 25, 35, 0.9);
        backdrop-filter: blur(20px);
        border-radius: 40px 0 0 40px;
        border: 1px solid var(--border-light);
        border-right: none;
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 30px;
        transition: var(--transition);
        z-index: 150;
        padding: 20px 0;
      }

      #quick-nav:hover {
        transform: translateY(-50%) translateX(0); /* Reveal */
        width: 100px;
      }

      .nav-item {
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        position: relative;
        transition: 0.3s;
      }

      .nav-item:hover {
        color: #fff;
        transform: scale(1.2);
      }

      .nav-tooltip {
        position: absolute;
        right: 50px;
        top: 50%;
        transform: translateY(-50%);
        background: #000;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        opacity: 0;
        pointer-events: none;
        white-space: nowrap;
        transition: 0.2s;
      }

      .nav-item:hover .nav-tooltip {
        opacity: 1;
        right: 60px;
      }

      /* --- 4. DETAILED CONTENT SCREEN --- */
      #content-screen {
        width: 95%;
        height: 95vh;
        background: var(--bg-panel);
        backdrop-filter: blur(30px);
        border-radius: 30px;
        border: 1px solid var(--border-light);
        box-shadow: var(--glass-shadow);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      .top-bar {
        padding: 25px 30px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.2);
      }

      .smart-search-box {
        position: relative;
        width: 300px;
      }

      .smart-search-box input {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border-radius: 20px;
        border: 1px solid var(--border-light);
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
      }

      .smart-search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
      }

      /* --- SMART GRID --- */
      .grid-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .smart-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px;
      }

      .smart-table th {
        text-align: right;
        padding: 15px;
        color: var(--text-muted);
        font-size: 0.9rem;
        font-weight: 600;
      }

      .smart-table tbody tr {
        background: rgba(255, 255, 255, 0.02);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: 0.2s;
        position: relative;
      }

      .smart-table tbody tr:hover {
        transform: scale(1.005);
        background: rgba(255, 255, 255, 0.05);
        z-index: 5;
      }

      .smart-table td {
        padding: 18px;
        border-top: 1px solid var(--border-light);
        border-bottom: 1px solid var(--border-light);
        color: #fff;
      }

      .smart-table td:first-child {
        border-radius: 0 15px 15px 0;
        border-right: 1px solid var(--border-light);
      }
      .smart-table td:last-child {
        border-radius: 15px 0 0 15px;
        border-left: 1px solid var(--border-light);
      }

      /* Quick Actions on Row Hover */
      .row-actions {
        opacity: 0;
        display: flex;
        gap: 10px;
        transition: 0.2s;
      }

      .smart-table tr:hover .row-actions {
        opacity: 1;
      }

      .icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8rem;
      }

      .icon-btn:hover {
        background: var(--text-muted);
        color: #000;
      }
      .icon-btn.view:hover {
        background: var(--color-sys);
        color: #fff;
      }
      .icon-btn.delete:hover {
        background: var(--color-fin);
        color: #fff;
      }

      /* Bulk Action Bar (Floating) */
      #bulk-bar {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--bg-panel);
        border: 1px solid var(--border-light);
        padding: 15px 30px;
        border-radius: 30px;
        box-shadow: var(--glass-shadow);
        display: flex;
        gap: 20px;
        align-items: center;
        transition: var(--transition);
        z-index: 50;
      }

      #bulk-bar.active {
        transform: translateX(-50%) translateY(0);
      }

      /* --- 5. DUAL MODE FORMS (Entry vs View) --- */
      #form-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 300;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .modal-glass {
        width: 750px;
        background: #151a24;
        border: 1px solid var(--border-light);
        border-radius: 25px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      /* Tabs (Entry Form) */
      .tabs {
        display: flex;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid var(--border-light);
      }
      .tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        color: var(--text-muted);
        transition: 0.3s;
        border-bottom: 3px solid transparent;
      }
      .tab.active {
        color: #fff;
        border-bottom-color: var(--color-hrm);
        background: rgba(255, 255, 255, 0.02);
      }

      .modal-body {
        padding: 30px;
        overflow-y: auto;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .field-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .field-group input,
      .field-group select {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-light);
        border-radius: 10px;
        color: #fff;
      }

      /* View Details Style (Read Only) */
      .view-details .field-group input {
        border: none;
        background: transparent;
        border-bottom: 1px solid var(--border-light);
        border-radius: 0;
        padding-left: 0;
        font-weight: 700;
        color: var(--color-sys); /* Highlight color */
      }
      .view-details label {
        color: #5c6bc0;
      } /* Different label color for view */

      .modal-footer {
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid var(--border-light);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <div class="login-glass">
        <div class="logo-text">
          NIJJARA<span
            style="
              font-size: 1.5rem;
              display: block;
              letter-spacing: 5px;
              color: #fff;
            "
            >ERP</span
          >
        </div>
        <div style="text-align: center; color: #8fa3bf; margin-bottom: 30px">
          بوابة الدخول الموحدة
        </div>

        <div class="input-box">
          <i class="fa-solid fa-user-astronaut"></i>
          <input
            type="text"
            class="input-field"
            id="username"
            value=""
            placeholder="اسم المستخدم"
          />
        </div>
        <div class="input-box">
          <i class="fa-solid fa-fingerprint"></i>
          <input
            type="password"
            class="input-field"
            id="password"
            value=""
            placeholder="كلمة المرور"
          />
        </div>

        <button class="btn-login" onclick="attemptLogin()">تسجيل الدخول</button>
      </div>
    </div>

    <div id="quick-nav" class="hidden">
      <div class="nav-item" onclick="goBackToDash()">
        <i class="fa-solid fa-house"></i>
        <span class="nav-tooltip">الرئيسية</span>
      </div>
      <div class="nav-item" onclick="alert('جارٍ تفعيل البحث الشامل...')">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span class="nav-tooltip">بحث</span>
      </div>
      <div class="nav-item" onclick="alert('لا توجد إشعارات جديدة')">
        <i class="fa-solid fa-bell"></i>
        <span class="nav-tooltip">الإشعارات</span>
      </div>
      <div class="nav-item" onclick="attemptLogout()">
        <i class="fa-solid fa-power-off" style="color: #ef5350"></i>
        <span class="nav-tooltip">خروج</span>
      </div>
    </div>

    <div id="dashboard-screen" class="hidden">
      <div class="module-card mod-sys">
        <i class="fa-solid fa-server module-icon"></i>
        <div class="module-title">النظام</div>
        <div class="sub-menu">
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_SYS_Users', 'المستخدمين')"
            ><i class="fa-solid fa-users"></i> المستخدمين</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_SYS_Roles', 'الأدوار')"
            ><i class="fa-solid fa-shield-halved"></i> الأدوار</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_SYS_Permissions', 'الصلاحيات')"
            ><i class="fa-solid fa-key"></i> الصلاحيات</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_SYS_AuditLog', 'السجلات')"
            ><i class="fa-solid fa-file-contract"></i> السجلات</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_SYS_Sessions', 'الجلسات')"
            ><i class="fa-solid fa-clock"></i> الجلسات</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_SYS_PubHolidays', 'العطلات')"
            ><i class="fa-solid fa-calendar"></i> العطلات</a
          >
        </div>
      </div>

      <div class="module-card mod-hrm">
        <i class="fa-solid fa-user-tie module-icon"></i>
        <div class="module-title">الموارد البشرية</div>
        <div class="sub-menu">
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_HRM_Employees', 'الموظفين')"
            ><i class="fa-solid fa-users-viewfinder"></i> الموظفين</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_HRM_Departments', 'الأقسام')"
            ><i class="fa-solid fa-sitemap"></i> الأقسام</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_HRM_Attendance', 'الحضور')"
            ><i class="fa-solid fa-fingerprint"></i> الحضور</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_HRM_Leave', 'الإجازات')"
            ><i class="fa-solid fa-plane"></i> الإجازات</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_HRM_Advances', 'السلف')"
            ><i class="fa-solid fa-hand-holding-dollar"></i> السلف</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_HRM_OverTime', 'الإضافي')"
            ><i class="fa-solid fa-stopwatch"></i> الإضافي</a
          >
        </div>
      </div>

      <div class="module-card mod-prj">
        <i class="fa-solid fa-helmet-safety module-icon"></i>
        <div class="module-title">المشاريع</div>
        <div class="sub-menu">
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_PRJ_Main', 'المشاريع')"
            ><i class="fa-solid fa-city"></i> المشاريع</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_PRJ_Tasks', 'المهام')"
            ><i class="fa-solid fa-list-check"></i> المهام</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_PRJ_Clients', 'العملاء')"
            ><i class="fa-solid fa-briefcase"></i> العملاء</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_PRJ_Material', 'المواد')"
            ><i class="fa-solid fa-cubes"></i> المواد</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_PRJ_Dashboard', 'لوحة القيادة')"
            ><i class="fa-solid fa-chart-line"></i> لوحة القيادة</a
          >
        </div>
      </div>

      <div class="module-card mod-fin">
        <i class="fa-solid fa-scale-balanced module-icon"></i>
        <div class="module-title">المالية</div>
        <div class="sub-menu">
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_FIN_Revenue', 'الإيرادات')"
            ><i class="fa-solid fa-money-bill-trend-up"></i> الإيرادات</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_FIN_DirectExpenses', 'م. المباشرة')"
            ><i class="fa-solid fa-file-invoice-dollar"></i> م. المباشرة</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_FIN_InDirectExpenses', 'م. العامة')"
            ><i class="fa-solid fa-receipt"></i> م. العامة</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_FIN_Custody', 'العهد')"
            ><i class="fa-solid fa-wallet"></i> العهد</a
          >
          <a
            href="#"
            class="sub-link"
            onclick="openModule('VIEW_FIN_Payroll', 'الرواتب')"
            ><i class="fa-solid fa-file-signature"></i> الرواتب</a
          >
        </div>
      </div>
    </div>

    <div id="content-screen" class="hidden">
      <div class="top-bar">
        <div style="display: flex; align-items: center; gap: 20px">
          <h2 style="font-size: 1.5rem; color: #fff" id="page-title">
            العنوان
          </h2>
          <div class="smart-search-box">
            <input
              type="text"
              id="smart-search-input"
              placeholder="بحث ذكي (الاسم، الكود، الرقم)..."
              onkeyup="debounceSearch(this.value)"
            />
            <i class="fa-solid fa-magnifying-glass"></i>
          </div>
        </div>
        <div>
          <button
            class="btn-login"
            style="padding: 10px 25px; width: auto; font-size: 0.9rem"
            onclick="openSmartForm('ADD')"
          >
            <i class="fa-solid fa-plus"></i> إضافة جديد
          </button>
        </div>
      </div>

      <div class="grid-container">
        <table class="smart-table">
          <thead id="grid-header-row"></thead>
          <tbody id="grid-body"></tbody>
        </table>
      </div>

      <div id="bulk-bar">
        <span style="color: #fff; font-weight: 700" id="bulk-count"
          >0 عناصر محددة</span
        >
        <button class="icon-btn delete" title="حذف المحدد">
          <i class="fa-solid fa-trash"></i>
        </button>
        <button class="icon-btn view" title="تفعيل">
          <i class="fa-solid fa-check"></i>
        </button>
        <button class="icon-btn" title="تصدير">
          <i class="fa-solid fa-file-export"></i>
        </button>
      </div>
    </div>

    <div id="form-modal" class="hidden">
      <div class="modal-glass">
        <div
          style="
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
          "
        >
          <h3 style="color: #fff" id="form-title">...</h3>
          <button class="icon-btn" onclick="closeForm()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="tabs" id="form-tabs"></div>

        <div class="modal-body" id="modal-content"></div>

        <div class="modal-footer">
          <button
            class="btn-login"
            style="width: auto; padding: 10px 30px"
            onclick="submitSmartForm()"
            id="btn-save-form"
          >
            حفظ
          </button>
          <button
            class="icon-btn"
            style="width: auto; padding: 0 20px; border-radius: 10px"
            onclick="closeForm()"
          >
            إلغاء
          </button>
        </div>
      </div>
    </div>

    <script>
      /**
       * Global State Management
       * Holds session tokens and configuration data fetched from Code.js
       */
      const APP_STATE = {
        sessionToken: null,
        currentUser: null,
        currentViewId: null,
        currentFormId: null,
        config: {}, // Holds ENG_ data
        searchTimeout: null, // For debouncing
      };

      // --- AUTHENTICATION MODULE ---

      function attemptLogin() {
        const u = document.getElementById("username").value;
        const p = document.getElementById("password").value;

        // UI Feedback
        const btn = document.querySelector(".btn-login");
        const originalText = btn.innerText;
        btn.innerText = "جارٍ التحقق...";
        btn.disabled = true;

        // CALL BACKEND: loginUser(username, password)
        google.script.run
          .withSuccessHandler(function (response) {
            // Parse response if it's a JSON string
            if (typeof response === "string") {
              try {
                response = JSON.parse(response);
              } catch (e) {
                console.error("Failed to parse response", e);
              }
            }

            if (response.status === "success" || response.success) {
              const data = response.data || response;
              APP_STATE.sessionToken = data.token;
              APP_STATE.currentUser = data.user;

              // Proceed to bootstrap
              fetchBootstrapData(data.token);
            } else {
              alert("فشل الدخول: " + (response.message || "Unknown error"));
              btn.innerText = originalText;
              btn.disabled = false;
            }
          })
          .withFailureHandler(function (err) {
            alert("Server Error: " + err);
            btn.innerText = originalText;
            btn.disabled = false;
          })
          .loginUser(u, p);
      }

      function fetchBootstrapData(token) {
        // CALL BACKEND: getBootstrapData(token)
        google.script.run
          .withSuccessHandler(function (response) {
            if (typeof response === "string") response = JSON.parse(response);
            if (response.status === "success") {
              initDashboard(response.data);
            } else {
              alert("Bootstrap failed: " + response.message);
            }
          })
          .getBootstrapData(token);
      }

      function initDashboard(bootstrapData) {
        // Save config
        APP_STATE.config = bootstrapData;

        // Transition UI
        const loginScreen = document.getElementById("login-screen");
        const dash = document.getElementById("dashboard-screen");
        const nav = document.getElementById("quick-nav");

        loginScreen.classList.add("fade-out");
        setTimeout(() => {
          loginScreen.classList.add("hidden");
          dash.classList.remove("hidden");
          dash.classList.add("fade-in");
          nav.classList.remove("hidden");
        }, 500);
      }

      function attemptLogout() {
        // Call logout in backend then reload
        google.script.run.logoutUser(APP_STATE.sessionToken);
        location.reload();
      }

      // --- VIEW ENGINE (SMART GRID) ---

      function openModule(viewId, title) {
        APP_STATE.currentViewId = viewId;

        // UI Transition
        const dash = document.getElementById("dashboard-screen");
        const content = document.getElementById("content-screen");

        dash.classList.add("fade-out");
        setTimeout(() => {
          dash.classList.add("hidden");
          dash.classList.remove("fade-out");
          content.classList.remove("hidden");
          content.classList.add("fade-in");
        }, 500);

        document.getElementById("page-title").innerText = title;
        document.getElementById("grid-body").innerHTML =
          '<tr><td colspan="10" style="text-align:center;">جارٍ تحميل البيانات...</td></tr>';

        // 1. Get View Configuration (Columns, Headers)
        google.script.run
          .withSuccessHandler(function (response) {
            if (typeof response === "string") response = JSON.parse(response);
            if (response.status === "success") {
              renderGridHeaders(response.data);
              // 2. Fetch Data
              fetchGridData(viewId);
            } else {
              alert("Error loading view: " + response.message);
            }
          })
          .getViewConfig(viewId);
      }

      function fetchGridData(viewId, filterCriteria = {}) {
        google.script.run
          .withSuccessHandler(function (response) {
            if (typeof response === "string") response = JSON.parse(response);
            if (response.status === "success") {
              renderGridBody(response.data);
            } else {
              alert("Error loading data: " + response.message);
            }
          })
          .fetchViewData(viewId, filterCriteria);
      }

      function debounceSearch(query) {
        clearTimeout(APP_STATE.searchTimeout);
        APP_STATE.searchTimeout = setTimeout(() => {
          fetchGridData(APP_STATE.currentViewId, { search: query });
        }, 500);
      }

      function renderGridHeaders(config) {
        const thead = document.getElementById("grid-header-row");
        // Store columns in state for rendering body
        APP_STATE.currentViewConfig = config;

        let html =
          '<tr><th style="width:50px;"><input type="checkbox" onchange="toggleBulk(this)"></th>';

        // Loop through configured columns from Smart Header Protocol (Row 3 = SHOW)
        config.columns.forEach((col) => {
          html += `<th>${col.label}</th>`;
        });

        html += "<th>إجراءات</th></tr>";
        thead.innerHTML = html;
      }

      function renderGridBody(data) {
        const tbody = document.getElementById("grid-body");
        tbody.innerHTML = "";

        const config = APP_STATE.currentViewConfig;
        // Determine ID key (usually first column or specified in config)
        // In Smart Header Protocol, the first column is the System Key (ID)
        const idKey = config.columns[0].key;

        data.forEach((row) => {
          const tr = document.createElement("tr");

          // Start with Checkbox
          let html = `<td><input type="checkbox" onchange="checkSelection()"></td>`;

          // Dynamic Data Cells based on Config
          config.columns.forEach((col) => {
            const val = row[col.key] || "";
            html += `<td>${val}</td>`;
          });

          // Action Buttons
          // We can use the ID from the first column for actions
          const recordId = row[idKey] || row[Object.keys(row)[0]];

          html += `
                    <td>
                        <div class="row-actions">
                            <button class="icon-btn view" onclick="openSmartForm('VIEW', '${recordId}')"><i class="fa-solid fa-eye"></i></button>
                            <button class="icon-btn" onclick="openSmartForm('EDIT', '${recordId}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="icon-btn delete"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                `;
          tr.innerHTML = html;
          tbody.appendChild(tr);
        });

        if (data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="10" style="text-align:center;">لا توجد بيانات</td></tr>';
        }
      }

      function goBackToDash() {
        const dash = document.getElementById("dashboard-screen");
        const content = document.getElementById("content-screen");

        content.classList.add("fade-out");
        setTimeout(() => {
          content.classList.add("hidden");
          content.classList.remove("fade-out");
          dash.classList.remove("hidden");
          dash.classList.add("fade-in");
        }, 500);
      }

      // --- FORM ENGINE (SMART FORMS) ---

      function openSmartForm(mode, recordId = null) {
        // Determine Form ID based on View (e.g., VIEW_HRM_Employees -> FORM_HRM_AddEmployee)
        // This logic is usually in ENG_Settings, but for now we infer it
        // Or we can look it up if we loaded ENG_Settings in bootstrap.
        // Assuming inference:
        // VIEW_HRM_Employees -> FORM_HRM_AddEmployee
        // Let's rely on standard naming or a mapping if available.
        // Fallback: Infer.
        // Replace VIEW_ with FORM_ and handle the suffix (Employees -> AddEmployee?)
        // Actually, ENG_Views has "Source_Sheet" (HRM_Employees).
        // ENG_Settings maps FORM_MASTER:FORM_HRM_AddEmployee -> HRM_Employees.
        // We need to reverse map Source Sheet to Form ID.
        // For MVP, we'll use a simplified mapping or hardcoded inference for standard modules.
        // Let's assume standard format: FORM_ + Module + _Add + EntityName
        // EntityName can be derived from View Title or ID.
        // Better approach: Pass Form ID from button if possible, or use a known map.

        // TEMPORARY INFERENCE for Demo:
        let formId = "FORM_UNK";
        if (APP_STATE.currentViewId) {
          const parts = APP_STATE.currentViewId.split("_"); // VIEW, HRM, Employees
          // Convert plural to singular? Or just use "Add" + Entity.
          // VIEW_HRM_Employees -> FORM_HRM_AddEmployee (Singular is hard to guess without map)
          // Let's try to match with config data if we had it.
          // For now, let's just replace VIEW_ with FORM_ and add 'Add' prefix to the last part if not present.
          // e.g. VIEW_HRM_Employees -> FORM_HRM_AddEmployee (Manual fix needed for strict NCM)

          // HACK: Use 'Add' + Part[2] (e.g. Employees)
          // This assumes Form ID uses Plural which matches View?
          // ENG_Forms: FORM_HRM_AddEmployee (Singular). VIEW_HRM_Employees (Plural).
          // We'll fix this by trying to find a matching form in a real app.
          // Here, let's hardcode a few common ones for the demo or use a heuristic.

          const entity = parts[2];
          // Simple singularization for common words
          let singular = entity;
          if (entity.endsWith("s")) singular = entity.slice(0, -1); // Employees -> Employee

          formId = `FORM_${parts[1]}_Add${singular}`;

          // Special cases
          if (parts[1] === "SYS" && entity === "Users")
            formId = "FORM_SYS_AddUser";
        }

        APP_STATE.currentFormId = formId;
        APP_STATE.currentRecordId = recordId;
        APP_STATE.formMode = mode;

        const modal = document.getElementById("form-modal");
        modal.classList.remove("hidden");
        modal.classList.add("fade-in");
        document.getElementById("modal-content").innerHTML =
          '<div style="color:white; text-align:center;">جلب هيكل النموذج...</div>';
        document.getElementById("form-tabs").innerHTML = ""; // Clear tabs

        // CALL BACKEND: getFormConfig(formId)
        google.script.run
          .withSuccessHandler(function (response) {
            if (typeof response === "string") response = JSON.parse(response);
            if (response.status === "success") {
              renderForm(response.data, mode, recordId);
            } else {
              document.getElementById(
                "modal-content"
              ).innerHTML = `<div style="color:red; text-align:center;">Form Config Not Found: ${formId}</div>`;
            }
          })
          .getFormConfig(formId);
      }

      function renderForm(schema, mode, recordId) {
        const content = document.getElementById("modal-content");
        const title = document.getElementById("form-title");
        const tabsContainer = document.getElementById("form-tabs");

        title.innerText =
          mode === "VIEW"
            ? "عرض التفاصيل"
            : mode === "EDIT"
            ? "تعديل سجل"
            : "إضافة سجل جديد";

        if (mode === "VIEW") {
          content.classList.add("view-details");
          document.getElementById("btn-save-form").style.display = "none";
        } else {
          content.classList.remove("view-details");
          document.getElementById("btn-save-form").style.display = "block";
        }

        // Group fields by TAB_Section
        const tabs = {};
        schema.fields.forEach((field) => {
          const tabName = field.TAB_Section || "Main";
          if (!tabs[tabName]) tabs[tabName] = [];
          tabs[tabName].push(field);
        });

        // Render Tabs
        const tabNames = Object.keys(tabs);
        if (tabNames.length > 1) {
          tabNames.forEach((t, i) => {
            const tabEl = document.createElement("div");
            tabEl.className = `tab ${i === 0 ? "active" : ""}`;
            tabEl.innerText = t;
            tabEl.onclick = () => switchTab(t);
            tabsContainer.appendChild(tabEl);
          });
        }

        // Render Fields
        let html = "";
        tabNames.forEach((t, i) => {
          const display = i === 0 ? "block" : "none";
          html += `<div class="tab-content" id="tab-${t}" style="display:${display}">`;
          html += '<div class="form-row">';

          tabs[t].forEach((field) => {
            const readonlyAttr =
              mode === "VIEW" ||
              field.Smart_State === "READ_ONLY" ||
              (mode === "EDIT" && field.Smart_State === "LOCKED_ON_EDIT")
                ? "readonly"
                : "";

            let inputHtml = "";
            if (field.Field_Type === "Dropdown") {
              // Check if options exist
              let optionsHtml = '<option value="">اختر...</option>';
              if (field.options) {
                field.options.forEach((opt) => {
                  optionsHtml += `<option value="${opt.value}">${opt.label}</option>`;
                });
              }
              inputHtml = `<select id="${field.Column_Pointer}" ${readonlyAttr} class="form-input">${optionsHtml}</select>`;
            } else {
              const type =
                field.Field_Type === "Number"
                  ? "number"
                  : field.Field_Type === "Date"
                  ? "date"
                  : "text";
              inputHtml = `<input type="${type}" id="${field.Column_Pointer}" ${readonlyAttr} class="form-input" placeholder="...">`;
            }

            html += `
                    <div class="field-group">
                        <label>${field.Column_Pointer} <span style="font-size:0.8em; opacity:0.7">(${field.Field_Type})</span></label>
                        ${inputHtml}
                    </div>
                `;
          });

          html += "</div></div>";
        });

        content.innerHTML = html;

        // If EDIT or VIEW, fetch data and populate
        if (recordId && recordId !== "NEW") {
          // We can reuse fetchViewData logic or a specific fetchRecord
          // For now, let's assume we can fetch by ID from the current view data (optimization)
          // or fetch from backend.
          // Backend fetch is safer.
          // Since we don't have a direct "getRecord" API exposed yet in the snippet,
          // we'll rely on the grid data if available, or just leave empty for this skeleton.
          // TODO: Implement getRecord(formId, recordId) in backend
        }
      }

      function switchTab(tabName) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        // Find tab element by text (simple way)
        const tabs = document.querySelectorAll(".tab");
        for (let t of tabs) {
          if (t.innerText === tabName) t.classList.add("active");
        }

        document
          .querySelectorAll(".tab-content")
          .forEach((c) => (c.style.display = "none"));
        document.getElementById(`tab-${tabName}`).style.display = "block";
      }

      function submitSmartForm() {
        const inputs = document.querySelectorAll(".form-input");
        const formData = {};

        inputs.forEach((input) => {
          formData[input.id] = input.value;
        });

        // Inject ID if update
        if (APP_STATE.currentRecordId && APP_STATE.currentRecordId !== "NEW") {
          // We need to know the ID key. Assuming schema convention or mapping.
          // Ideally we get this from config.
          // For now, we assume the first field or the ID field matches the recordId key.
        }

        // Add Token
        const token = APP_STATE.sessionToken;

        const btn = document.getElementById("btn-save-form");
        const originalText = btn.innerText;
        btn.innerText = "جارٍ الحفظ...";
        btn.disabled = true;

        // CALL BACKEND: processFormSubmission(formId, data, token)
        google.script.run
          .withSuccessHandler(function (response) {
            if (typeof response === "string") response = JSON.parse(response);
            if (response.status === "success") {
              alert("تم الحفظ بنجاح");
              closeForm();
              // Refresh Grid
              fetchGridData(APP_STATE.currentViewId);
            } else {
              alert("خطأ في الحفظ: " + response.message);
            }
            btn.innerText = originalText;
            btn.disabled = false;
          })
          .processFormSubmission(APP_STATE.currentFormId, formData, token);
      }

      function closeForm() {
        document.getElementById("form-modal").classList.add("hidden");
      }

      // --- UTILS ---
      function toggleBulk(source) {
        const cbs = document.querySelectorAll('tbody input[type="checkbox"]');
        cbs.forEach((cb) => (cb.checked = source.checked));
        checkSelection();
      }

      function checkSelection() {
        const checked = document.querySelectorAll(
          'tbody input[type="checkbox"]:checked'
        );
        const bar = document.getElementById("bulk-bar");
        document.getElementById("bulk-count").innerText =
          checked.length + " عناصر محددة";

        if (checked.length > 0) bar.classList.add("active");
        else bar.classList.remove("active");
      }
    </script>
  </body>
</html>
